{% extends 'base.html' %}

{% block title %}–°–ø–∏—Å–æ–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤{% endblock %}

{% block content %}
<h2>–°–ø–∏—Å–æ–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</h2>

<table class="table table-hover table-bordered">
    <thead>
        <tr>
            <th>ID</th>
            <th>–ò–º—è</th>
            <th>–§–∞–º–∏–ª–∏—è</th>
            <th>Email</th>
            <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
            <th>–î–æ–ª–∂–Ω–æ—Å—Ç—å</th>
            <th>–ë–∞–∑–æ–≤–∞—è –∑–∞—Ä–ø–ª–∞—Ç–∞</th>
            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr>
    </thead>
    <tbody id="employees-table"></tbody>
</table>

<h3>–î–æ–±–∞–≤–∏—Ç—å/–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</h3>
<form id="employee-form" class="card p-3 shadow">
    <input type="hidden" id="employee_id">

    <label for="first_name" class="form-label">–ò–º—è:</label>
    <input type="text" id="first_name" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è" required>

     <label for="last_name" class="form-label mt-2">–§–∞–º–∏–ª–∏—è:</label>
    <input type="text" id="last_name" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ñ–∞–º–∏–ª–∏—é" required>

    <label for="last_name" class="form-label mt-2">–ü–æ—á—Ç–∞:</label>
    <input type="email" id="email" class="form-control" placeholder="Email" required>

    <label for="last_name" class="form-label mt-2">–¢–µ–ª-–Ω–æ–º:</label>
    <input type="text" id="phone" class="form-control" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">

    <label for="position" class="form-label mt-2">–î–æ–ª–∂–Ω–æ—Å—Ç—å:</label>
    <select id="position" class="form-select" required>
        <option value="Manager">–ú–µ–Ω–µ–¥–∂–µ—Ä</option>
        <option value="Developer">–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫</option>
        <option value="Analyst">–ê–Ω–∞–ª–∏—Ç–∏–∫</option>
        <option value="HR">HR</option>
        <option value="Accountant">–ë—É—Ö–≥–∞–ª—Ç–µ—Ä</option>
        <option value="Designer">–î–∏–∑–∞–π–Ω–µ—Ä</option>
    </select>

    <label for="last_name" class="form-label mt-2">–ó–∞—Ä-–ø–ª–∞—Ç–∞:</label>
    <input type="number" id="base_salary" class="form-control" placeholder="–ë–∞–∑–æ–≤–∞—è –∑–∞—Ä–ø–ª–∞—Ç–∞" required>

    <button class="btn btn-primary mt-3" type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
</form>

<script>
    function getCSRFToken() {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            document.cookie.split(';').forEach(cookie => {
                let [name, value] = cookie.trim().split('=');
                if (name === 'csrftoken') cookieValue = decodeURIComponent(value);
            });
        }
        return cookieValue;
    }

    async function loadEmployees() {
        let response = await fetch("/api/employees/");
        let data = await response.json();
        let table = document.getElementById("employees-table");
        table.innerHTML = "";
        data.forEach(emp => {
            let row = `<tr>
                <td>${emp.id}</td>
                <td>${emp.first_name}</td>
                <td>${emp.last_name}</td>
                <td>${emp.email}</td>
                <td>${emp.phone}</td>
                <td>${emp.position}</td>
                <td>${emp.base_salary}</td>
                <td>
                    <button class="btn btn-warning btn-sm" onclick="editEmployee(${emp.id}, '${emp.first_name}', '${emp.last_name}', '${emp.email}', '${emp.phone}', '${emp.position}', ${emp.base_salary})">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteEmployee(${emp.id})">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                </td>
            </tr>`;
            table.innerHTML += row;
        });
    }

     function editEmployee(id, first_name, last_name, email, phone, position, base_salary) {
        document.getElementById("employee_id").value = id;
        document.getElementById("first_name").value = first_name;
        document.getElementById("last_name").value = last_name;
        document.getElementById("email").value = email;
        document.getElementById("phone").value = phone;
        document.getElementById("position").value = position;
        document.getElementById("base_salary").value = base_salary;
    }

    document.getElementById("employee-form").addEventListener("submit", async function(e) {
        e.preventDefault();

        let id = document.getElementById("employee_id").value;
        let url = id ? `/api/employees/${id}/` : "/api/employees/";
        let method = id ? "PUT" : "POST";

        let employeeData = {
            first_name: document.getElementById("first_name").value,
            last_name: document.getElementById("last_name").value,
            email: document.getElementById("email").value,
            phone: document.getElementById("phone").value,
            position: document.getElementById("position").value,
            base_salary: document.getElementById("base_salary").value
        };

        await fetch(url, {
            method: method,
            headers: { "Content-Type": "application/json", "X-CSRFToken": getCSRFToken() },
            body: JSON.stringify(employeeData)
        });
        loadEmployees();
    });

    async function deleteEmployee(id) {
        if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞?")) {
            await fetch(`/api/employees/${id}/`, { method: "DELETE", headers: { "X-CSRFToken": getCSRFToken() } });
            loadEmployees();
        }
    }

    document.addEventListener("DOMContentLoaded", loadEmployees);
</script>

{% endblock %}
