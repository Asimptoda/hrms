{% extends 'base.html' %}

{% block title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—É—Ä—Å–∞–º–∏{% endblock %}

{% block content %}
<h2>–ö—É—Ä—Å—ã –æ–±—É—á–µ–Ω–∏—è</h2>

<table class="table table-hover">
    <thead>
        <tr>
            <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
            <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
            <th>–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</th>
            <th>–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</th>
            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr>
    </thead>
    <tbody id="courses-table"></tbody>
</table>

<h3 id="course-form-title">–î–æ–±–∞–≤–∏—Ç—å –∫—É—Ä—Å</h3>
<form id="course-form">
    <input type="hidden" id="course_id">

    <label>–ù–∞–∑–≤–∞–Ω–∏–µ –∫—É—Ä—Å–∞:</label>
    <input type="text" id="course_title" class="form-control" required>

    <label>–û–ø–∏—Å–∞–Ω–∏–µ:</label>
    <textarea id="course_description" class="form-control"></textarea>

    <label>–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞:</label>
    <input type="date" id="course_start_date" class="form-control" required>

    <label>–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è:</label>
    <input type="date" id="course_end_date" class="form-control" required>

    <button type="submit" class="btn btn-primary mt-3">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <button type="button" class="btn btn-secondary mt-3" onclick="resetForm()">–û—á–∏—Å—Ç–∏—Ç—å</button>
</form>

<script>
function getCSRFToken() {
    let cookieValue = null;
    document.cookie.split(';').forEach(cookie => {
        let [name, value] = cookie.trim().split('=');
        if (name === 'csrftoken') cookieValue = decodeURIComponent(value);
    });
    return cookieValue;
}

async function loadCourses() {
    let response = await fetch("/api/training/");
    let data = await response.json();
    let table = document.getElementById("courses-table");
    table.innerHTML = "";
    data.forEach(course => {
        table.innerHTML += `<tr>
            <td>${course.title}</td>
            <td>${course.description || "‚Äî"}</td>
            <td>${course.start_date}</td>
            <td>${course.end_date}</td>
            <td>
                <button class="btn btn-warning btn-sm" onclick="editCourse(${course.id}, '${course.title}', '${course.description}', '${course.start_date}', '${course.end_date}')">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                <button class="btn btn-danger btn-sm" onclick="deleteCourse(${course.id})">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
            </td>
        </tr>`;
    });
}

function editCourse(id, title, description, start_date, end_date) {
    document.getElementById("course_id").value = id;
    document.getElementById("course_title").value = title;
    document.getElementById("course_description").value = description;
    document.getElementById("course_start_date").value = start_date;
    document.getElementById("course_end_date").value = end_date;
    document.getElementById("course-form-title").innerText = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫—É—Ä—Å";
}

function resetForm() {
    document.getElementById("course_id").value = "";
    document.getElementById("course_title").value = "";
    document.getElementById("course_description").value = "";
    document.getElementById("course_start_date").value = "";
    document.getElementById("course_end_date").value = "";
    document.getElementById("course-form-title").innerText = "–î–æ–±–∞–≤–∏—Ç—å –∫—É—Ä—Å";
}

document.getElementById("course-form").addEventListener("submit", async function(e) {
    e.preventDefault();

    let id = document.getElementById("course_id").value;
    let url = id ? `/api/training/${id}/` : "/api/training/";
    let method = id ? "PUT" : "POST";

    let data = {
        title: document.getElementById("course_title").value,
        description: document.getElementById("course_description").value,
        start_date: document.getElementById("course_start_date").value,
        end_date: document.getElementById("course_end_date").value
    };

    let response = await fetch(url, {
        method: method,
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCSRFToken()
        },
        body: JSON.stringify(data)
    });

    if (!response.ok) {
        let error = await response.json();
        console.error("–û—à–∏–±–∫–∞:", error);
        alert("–û—à–∏–±–∫–∞: " + JSON.stringify(error));
        return;
    }

    resetForm();
    loadCourses();
});

async function deleteCourse(id) {
    if (!confirm("–£–¥–∞–ª–∏—Ç—å –∫—É—Ä—Å?")) return;

    let response = await fetch(`/api/training/${id}/`, {
        method: "DELETE",
        headers: { "X-CSRFToken": getCSRFToken() }
    });

    if (response.ok) {
        loadCourses();
    } else {
        let error = await response.json();
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏:", error);
        alert("–û—à–∏–±–∫–∞: " + JSON.stringify(error));
    }
}

document.addEventListener("DOMContentLoaded", function() {
    loadCourses();
});
</script>
{% endblock %}
