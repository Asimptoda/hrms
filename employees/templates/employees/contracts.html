{% extends 'base.html' %}

{% block title %}–ö–æ–Ω—Ç—Ä–∞–∫—Ç—ã{% endblock %}

{% block content %}
<h2>–ö–æ–Ω—Ç—Ä–∞–∫—Ç—ã —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</h2>

<table class="table table-hover table-bordered">
    <thead>
        <tr>
            <th>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>
            <th>–¢–∏–ø –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞</th>
            <th>–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</th>
            <th>–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</th>
            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr>
    </thead>
    <tbody id="contracts-table"></tbody>
</table>

<h3>–î–æ–±–∞–≤–∏—Ç—å/–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ç—Ä–∞–∫—Ç</h3>
<form id="contract-form" class="card p-3 shadow">
    <input type="hidden" id="contract_id">

    <label for="contract_employee" class="form-label">–°–æ—Ç—Ä—É–¥–Ω–∏–∫:</label>
    <select id="contract_employee" class="form-select" required></select>

    <label for="contract_type" class="form-label mt-2">–¢–∏–ø –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞:</label>
    <select id="contract_type" class="form-select">
        <option value="Full-time">–ü–æ–ª–Ω—ã–π —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å</option>
        <option value="Part-time">–ß–∞—Å—Ç–∏—á–Ω–∞—è –∑–∞–Ω—è—Ç–æ—Å—Ç—å</option>
        <option value="Freelance">–§—Ä–∏–ª–∞–Ω—Å</option>
    </select>

    <label for="contract_start" class="form-label mt-2">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞:</label>
    <input type="date" id="contract_start" class="form-control" required>

    <label for="contract_end" class="form-label mt-2">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è:</label>
    <input type="date" id="contract_end" class="form-control" required>

    <button class="btn btn-primary mt-3" type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
</form>

<script>
    function getCSRFToken() {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            document.cookie.split(';').forEach(cookie => {
                let [name, value] = cookie.trim().split('=');
                if (name === 'csrftoken') cookieValue = decodeURIComponent(value);
            });
        }
        return cookieValue;
    }

    async function loadEmployees() {
        let response = await fetch("/api/employees/");
        let employees = await response.json();
        let select = document.getElementById("contract_employee");
        select.innerHTML = `<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</option>`;

        employees.forEach(emp => {
            let option = `<option value="${emp.id}">${emp.first_name} ${emp.last_name}</option>`;
            select.innerHTML += option;
        });
    }

    async function loadContracts() {
        try {
            let response = await fetch("/api/contracts/");
            if (!response.ok) throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${response.status}`);

            let contracts = await response.json();
            let table = document.getElementById("contracts-table");
            table.innerHTML = "";

            if (contracts.length === 0) {
                table.innerHTML = "<tr><td colspan='5' class='text-center'>–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤</td></tr>";
                return;
            }

            contracts.forEach(contract => {
                let employeeName = contract.employee
                    ? `${contract.employee.first_name} ${contract.employee.last_name}`
                    : "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫";

                let row = `<tr>
                    <td>${employeeName}</td>
                    <td>${contract.contract_type}</td>
                    <td>${contract.start_date}</td>
                    <td>${contract.end_date || "–ù–µ —É–∫–∞–∑–∞–Ω–æ"}</td>
                    <td>
                        <button class="btn btn-warning btn-sm" onclick="editContract(${contract.id}, ${contract.employee?.id || 'null'}, '${contract.contract_type}', '${contract.start_date}', '${contract.end_date || ''}')">‚úèÔ∏è</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteContract(${contract.id})">üóëÔ∏è</button>
                    </td>
                </tr>`;
                table.innerHTML += row;
            });

        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤:", error);
        }
    }

    document.addEventListener("DOMContentLoaded", () => {
        loadContracts();
    });

    function editContract(id, employeeId, contractType, startDate, endDate) {
        document.getElementById("contract_id").value = id;
        document.getElementById("contract_employee").value = employeeId;
        document.getElementById("contract_type").value = contractType;
        document.getElementById("contract_start").value = startDate;
        document.getElementById("contract_end").value = endDate;
    }

     async function deleteContract(id) {
        if (!confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∫–æ–Ω—Ç—Ä–∞–∫—Ç?")) return;

        try {
            let response = await fetch(`/api/contracts/${id}/`, { method: "DELETE" });
            if (!response.ok) throw new Error("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è");

            loadContracts();
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞:", error);
        }
    }

    document.getElementById("contract-form").addEventListener("submit", async function(e) {
        e.preventDefault();
        let id = document.getElementById("contract_id").value;
        let data = {
            employee_id: document.getElementById("contract_employee").value,  // –ü–µ—Ä–µ–¥–∞–µ–º employee_id
            start_date: document.getElementById("contract_start").value,
            end_date: document.getElementById("contract_end").value,
            contract_type: document.getElementById("contract_type").value
        };
        let url = id ? `/api/contracts/${id}/` : "/api/contracts/";
        let method = id ? "PUT" : "POST";

        let response = await fetch(url, {
            method: method,
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCSRFToken()
            },
            body: JSON.stringify(data)
        });

        if (response.ok) {
            loadContracts();
            document.getElementById("contract-form").reset();
            document.getElementById("contract_id").value = "";
        } else {
            let errorData = await response.json();
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏:", errorData);
        }
    });

    document.addEventListener("DOMContentLoaded", () => {
        loadEmployees();  // ‚úÖ –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        loadContracts();
    });
</script>

{% endblock %}
