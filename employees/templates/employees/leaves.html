{% extends 'base.html' %}

{% block title %}–û—Ç–ø—É—Å–∫–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤{% endblock %}

{% block content %}
<h2>–û—Ç–ø—É—Å–∫–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</h2>

<table class="table table-hover table-bordered">
    <thead>
        <tr>
            <th>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>
            <th>–¢–∏–ø</th>
            <th>–ù–∞—á–∞–ª–æ</th>
            <th>–ö–æ–Ω–µ—Ü</th>
            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr>
    </thead>
    <tbody id="leaves-table"></tbody>
</table>

<h3>–î–æ–±–∞–≤–∏—Ç—å/–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–ø—É—Å–∫</h3>
<form id="leave-form" class="card p-3 shadow">
    <input type="hidden" id="leave_id">

    <label for="leave_employee" class="form-label">–°–æ—Ç—Ä—É–¥–Ω–∏–∫:</label>
    <select id="leave_employee" class="form-select" required></select>

    <label for="leave_type" class="form-label mt-2">–¢–∏–ø –æ—Ç–ø—É—Å–∫–∞:</label>
    <select id="leave_type" class="form-select">
        <option value="Vacation">–û—Ç–ø—É—Å–∫</option>
        <option value="Sick">–ë–æ–ª—å–Ω–∏—á–Ω—ã–π</option>
        <option value="Unpaid">–ù–µ–æ–ø–ª–∞—á–∏–≤–∞–µ–º—ã–π –æ—Ç–ø—É—Å–∫</option>
    </select>

    <label for="leave_start" class="form-label mt-2">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞:</label>
    <input type="date" id="leave_start" class="form-control" required>

    <label for="leave_end" class="form-label mt-2">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è:</label>
    <input type="date" id="leave_end" class="form-control" required>

    <button class="btn btn-primary mt-3" type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
</form>

<script>
    const leaveTypeTranslation = {
        "Vacation": "–û—Ç–ø—É—Å–∫",
        "Sick": "–ë–æ–ª—å–Ω–∏—á–Ω—ã–π",
        "Unpaid": "–ù–µ–æ–ø–ª–∞—á–∏–≤–∞–µ–º—ã–π –æ—Ç–ø—É—Å–∫"
    };

    function getCSRFToken() {
        let cookieValue = null;
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.startsWith('csrftoken=')) {
                cookieValue = decodeURIComponent(cookie.substring('csrftoken='.length));
                break;
            }
        }
        return cookieValue;
    }

    async function loadEmployees() {
        let response = await fetch("/api/employees/");
        let data = await response.json();
        let select = document.getElementById("leave_employee");
        select.innerHTML = `<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</option>`;

        data.forEach(emp => {
            let option = `<option value="${emp.id}">${emp.first_name} ${emp.last_name}</option>`;
            select.innerHTML += option;
        });
    }

    document.addEventListener("DOMContentLoaded", () => {
        loadEmployees();
    });

    async function loadLeaves() {
        let response = await fetch("/api/leaves/");
        let data = await response.json();
        let table = document.getElementById("leaves-table");
        table.innerHTML = "";
        data.forEach(leave => {
            let employeeName = leave.employee ? `${leave.employee.first_name} ${leave.employee.last_name}` : "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ";
            let translatedLeaveType = leaveTypeTranslation[leave.leave_type] || leave.leave_type;
            let row = `<tr>
                <td>${employeeName}</td>
                <td>${translatedLeaveType}</td>
                <td>${leave.start_date}</td>
                <td>${leave.end_date}</td>
                <td>
                    <button class="btn btn-warning btn-sm" onclick="editLeave(${leave.id}, ${leave.employee.id}, '${leave.leave_type}', '${leave.start_date}', '${leave.end_date}')">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteLeave(${leave.id})" style="color: black;">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                </td>
            </tr>`;
            table.innerHTML += row;
        });
    }

    function editLeave(id, employee, type, start, end) {
        document.getElementById("leave_id").value = id;
        document.getElementById("leave_employee").value = employee;
        document.getElementById("leave_type").value = type;
        document.getElementById("leave_start").value = start;
        document.getElementById("leave_end").value = end;
    }

     async function saveLeave(event) {
        event.preventDefault();

        let id = document.getElementById("leave_id").value;
        let data = {
            employee_id: Number(document.getElementById("leave_employee").value), // ‚úÖ employee_id –∏–º–µ–Ω–Ω–æ —Ç–∞–∫!
            leave_type: document.getElementById("leave_type").value,
            start_date: document.getElementById("leave_start").value,
            end_date: document.getElementById("leave_end").value
        };

        let url = id ? `/api/leaves/${id}/` : "/api/leaves/";
        let method = id ? "PUT" : "POST";

        try {
            let response = await fetch(url, {
                method: method,
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCSRFToken()
                },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                console.log("–û—Ç–ø—É—Å–∫ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω—ë–Ω!");
                loadLeaves();
                document.getElementById("leave-form").reset();
                document.getElementById("leave_id").value = "";
            } else {
                let errorData = await response.json();
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –æ—Ç–ø—É—Å–∫–∞:", errorData);
            }
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:", error);
        }
    }

    document.getElementById("leave-form").addEventListener("submit", saveLeave);


    // ‚úÖ –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ —Ä–∞–±–æ—á–∏–π –∫–æ–¥:
    async function deleteLeave(id) {
        if (!confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –æ—Ç–ø—É—Å–∫?")) return;

        try {
            let response = await fetch(`/api/leaves/${id}/`, {
                method: "DELETE",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCSRFToken()
                },
                credentials: 'include'  // ‚úÖ –¥–æ–±–∞–≤—å —ç—Ç—É —Å—Ç—Ä–æ–∫—É!
            });

            if (response.ok) {
                console.log("–û—Ç–ø—É—Å–∫ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª—ë–Ω!");
                loadLeaves();
            } else {
                let errorData = await response.json();
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏:", errorData);
            }
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:", error);
        }
    }


    document.getElementById("leave-form").addEventListener("submit", saveLeave);
    document.addEventListener("DOMContentLoaded", () => {
        loadEmployees();
        loadLeaves();
    });
</script>
{% endblock %}
