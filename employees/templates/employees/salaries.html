{% extends 'base.html' %}

{% block title %}–ó–∞—Ä–ø–ª–∞—Ç—ã —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤{% endblock %}

{% block content %}
<h2>–ó–∞—Ä–ø–ª–∞—Ç—ã —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</h2>

<table class="table table-hover table-bordered">
    <thead>
        <tr>
            <th>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>
            <th>–ú–µ—Å—è—Ü</th>
            <th>–ì–æ–¥</th>
            <th>–ë–∞–∑–æ–≤–∞—è —Å—Ç–∞–≤–∫–∞</th>
            <th>–ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∏ (—á–∞—Å—ã)</th>
            <th>–ù–µ–æ–ø–ª–∞—á. –æ—Ç–ø—É—Å–∫ (–¥–Ω–∏)</th>
            <th>–ë–æ–Ω—É—Å—ã</th>
            <th>–í—ã—á–µ—Ç—ã</th>
            <th>–ò—Ç–æ–≥–æ–≤–∞—è –∑–∞—Ä–ø–ª–∞—Ç–∞</th>
            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr>
    </thead>
    <tbody id="salaries-table"></tbody>
</table>

    <div class="row mb-3">
    <div class="col-md-3">
        <label for="filter_employee" class="form-label">–§–∏–ª—å—Ç—Ä –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É:</label>
        <select id="filter_employee" class="form-select"><option value="">–í—Å–µ</option></select>
    </div>
    <div class="col-md-2">
        <label for="filter_month" class="form-label">–ú–µ—Å—è—Ü:</label>
        <select id="filter_month" class="form-select">
            <option value="">–í—Å–µ</option>
            <option value="1">–Ø–Ω–≤–∞—Ä—å</option>
            <option value="2">–§–µ–≤—Ä–∞–ª—å</option>
            <option value="3">–ú–∞—Ä—Ç</option>
            <option value="4">–ê–ø—Ä–µ–ª—å</option>
            <option value="5">–ú–∞–π</option>
            <option value="6">–ò—é–Ω—å</option>
            <option value="7">–ò—é–ª—å</option>
            <option value="8">–ê–≤–≥—É—Å—Ç</option>
            <option value="9">–°–µ–Ω—Ç—è–±—Ä—å</option>
            <option value="10">–û–∫—Ç—è–±—Ä—å</option>
            <option value="11">–ù–æ—è–±—Ä—å</option>
            <option value="12">–î–µ–∫–∞–±—Ä—å</option>
        </select>
    </div>
    <div class="col-md-2">
        <label for="filter_year" class="form-label">–ì–æ–¥:</label>
        <input type="number" id="filter_year" class="form-control" placeholder="2025">
    </div>
    <div class="col-md-2">
        <button class="btn btn-primary mt-4" onclick="applyFilters()">üîç –ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
    </div>
</div>

<div class="d-flex justify-content-between align-items-center my-3">
    <h3>–û—Ç—á–µ—Ç—ã –ø–æ –∑–∞—Ä–ø–ª–∞—Ç–µ</h3>
    <div>
        <button class="btn btn-outline-primary" onclick="downloadReport('excel')">üìä –°–∫–∞—á–∞—Ç—å –≤ Excel</button>
        <button class="btn btn-outline-danger" onclick="downloadReport('pdf')">üìÑ –°–∫–∞—á–∞—Ç—å –≤ PDF</button>
    </div>
</div>

<h3>–î–æ–±–∞–≤–∏—Ç—å/–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞—Ä–ø–ª–∞—Ç—É</h3>
<form id="salary-form" class="card p-3 shadow">
    <input type="hidden" id="salary_id">

    <label for="salary_employee" class="form-label">–°–æ—Ç—Ä—É–¥–Ω–∏–∫:</label>
    <select id="salary_employee" class="form-select" required></select>

    <label for="salary_month" class="form-label">–ú–µ—Å—è—Ü:</label>
    <select id="salary_month" class="form-select" required>
        <option value="1">–Ø–Ω–≤–∞—Ä—å</option>
        <option value="2">–§–µ–≤—Ä–∞–ª—å</option>
        <option value="3">–ú–∞—Ä—Ç</option>
        <option value="4">–ê–ø—Ä–µ–ª—å</option>
        <option value="5">–ú–∞–π</option>
        <option value="6">–ò—é–Ω—å</option>
        <option value="7">–ò—é–ª—å</option>
        <option value="8">–ê–≤–≥—É—Å—Ç</option>
        <option value="9">–°–µ–Ω—Ç—è–±—Ä—å</option>
        <option value="10">–û–∫—Ç—è–±—Ä—å</option>
        <option value="11">–ù–æ—è–±—Ä—å</option>
        <option value="12">–î–µ–∫–∞–±—Ä—å</option>
    </select>

    <label for="salary_year" class="form-label mt-2">–ì–æ–¥:</label>
    <input type="number" id="salary_year" placeholder="–í–≤–µ–¥–∏—Ç–µ –≥–æ–¥" class="form-control" required>

    <label for="salary_base" class="form-label mt-2">–ë–∞–∑–æ–≤–∞—è –∑–∞—Ä–ø–ª–∞—Ç–∞:</label>
    <input type="number" id="salary_base" placeholder="–í–≤–µ–¥–∏—Ç–µ –±–∞–∑–æ–≤—É—é –∑–∞—Ä–ø–ª–∞—Ç—É" class="form-control" required>

    <label for="overtime_hours" class="form-label mt-2">–ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∞ (—á–∞—Å—ã):</label>
    <input type="number" id="overtime_hours" placeholder="–í–≤–µ–¥–∏—Ç–µ —á–∞—Å—ã –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–æ–∫" class="form-control" required>

    <label for="unpaid_leave_days" class="form-label mt-2">–ù–µ–æ–ø–ª–∞—á–∏–≤–∞–µ–º—ã–π –æ—Ç–ø—É—Å–∫ (–¥–Ω–∏):</label>
    <input type="number" id="unpaid_leave_days" placeholder="–í–≤–µ–¥–∏—Ç–µ –¥–Ω–∏ –ù–µ–æ–ø–ª–∞—á–∏–≤–∞–µ–º–æ–≥–æ –æ—Ç–ø—É—Å–∫–∞" class="form-control" required>

    <label for="salary_bonuses" class="form-label mt-2">–ë–æ–Ω—É—Å—ã:</label>
    <input type="number" id="salary_bonuses" placeholder="–í–≤–µ–¥–∏—Ç–µ –±–æ–Ω—É—Å—ã" class="form-control" required>

    <label for="salary_deductions" class="form-label mt-2">–í—ã—á–µ—Ç—ã:</label>
    <input type="number" id="salary_deductions" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤—ã—á–µ—Ç—ã" class="form-control" required>

    <button class="btn btn-primary mt-3" type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
</form>

<script>
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è CSRF-—Ç–æ–∫–µ–Ω–∞ –∏–∑ cookie
    function getCSRFToken() {
    let cookieValue = null;
    document.cookie.split(';').forEach(cookie => {
        let [name, value] = cookie.trim().split('=');
        if (name === 'csrftoken') cookieValue = decodeURIComponent(value);
    });
    return cookieValue;
}


    async function loadEmployees() {
        let response = await fetch("/api/employees/");
        let data = await response.json();
        let select = document.getElementById("salary_employee");

        select.innerHTML = `<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</option>`;  // ‚úÖ –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Å—Ç–æ–π –≤–∞—Ä–∏–∞–Ω—Ç
        data.forEach(emp => {
            let option = `<option value="${emp.id}">${emp.first_name} ${emp.last_name}</option>`;
            select.innerHTML += option;
        });
    }

    async function loadEmployeesForFilter() {
        const select = document.getElementById('filter_employee');
        select.innerHTML = '<option value="">–í—Å–µ</option>'; // –û–±–Ω—É–ª—è–µ–º –∏ –¥–æ–±–∞–≤–ª—è–µ–º "–í—Å–µ"

        let response = await fetch('/api/employees/');
        let employees = await response.json();

        employees.forEach(emp => {
            let option = document.createElement('option');
            option.value = emp.id;
            option.text = emp.first_name + " " + emp.last_name;
            select.appendChild(option);
        });
    }


    async function filterSalaries() {
    let employeeId = document.getElementById("filter_employee").value;
    let url = employeeId ? `/api/salaries/?employee_id=${employeeId}` : "/api/salaries/";

    let response = await fetch(url);
    let data = await response.json();
    let table = document.getElementById("salaries-table");
    table.innerHTML = "";

    data.forEach(sal => {
        let row = `<tr>
            <td>${sal.employee.first_name} ${sal.employee.last_name}</td>
            <td>${sal.month}</td>
            <td>${sal.year}</td>
            <td>${sal.base_salary}</td>
            <td>${sal.overtime_hours}</td>
            <td>${sal.unpaid_leave_days}</td>
            <td>${sal.bonuses}</td>
            <td>${sal.deductions}</td>
            <td>${sal.total_salary}</td>
            <td>
                <button class="btn btn-warning btn-sm" onclick="editSalary(${sal.id}, ${sal.employee.id}, ${sal.month}, ${sal.year}, ${sal.base_salary}, ${sal.overtime_hours}, ${sal.unpaid_leave_days}, ${sal.bonuses}, ${sal.deductions})">‚úèÔ∏è</button>
                <button class="btn btn-danger btn-sm" onclick="deleteSalary(${sal.id})">üóëÔ∏è</button>
            </td>
        </tr>`;
        table.innerHTML += row;
    });
}

    async function loadSalaries() {
        let employeeId = document.getElementById("filter_employee").value;
        let month = document.getElementById("filter_month").value;
        let year = document.getElementById("filter_year").value;

        let url = "/api/salaries/";
        let params = new URLSearchParams();

        if (employeeId) params.append("employee", employeeId);
        if (month) params.append("month", month);
        if (year) params.append("year", year);

        let response = await fetch(url + "?" + params.toString());
        let data = await response.json();
        let table = document.getElementById("salaries-table");
        table.innerHTML = "";

        data.forEach(sal => {
            let employeeName = sal.employee ? `${sal.employee.first_name} ${sal.employee.last_name}` : "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫";
            let employeeId = sal.employee?.id ?? sal.employee;

            let row = `<tr>
                <td>${employeeName}</td>
                <td>${sal.month}</td>
                <td>${sal.year}</td>
                <td>${sal.base_salary}</td>
                <td>${sal.overtime_hours || 0}</td>
                <td>${sal.unpaid_leave_days || 0}</td>
                <td>${sal.bonuses}</td>
                <td>${sal.deductions}</td>
                <td>${sal.total_salary}</td>
                <td>
                    <button class="btn btn-warning btn-sm" onclick="editSalary(${sal.id}, ${employeeId}, ${sal.month}, ${sal.year}, ${sal.base_salary}, ${sal.overtime_hours}, ${sal.unpaid_leave_days}, ${sal.bonuses}, ${sal.deductions})">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteSalary(${sal.id})">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                </td>
            </tr>`;
            table.innerHTML += row;
        });
    }

    function applyFilters() {
        loadSalaries();
    }



    async function deleteSalary(id) {
        if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å –æ –∑–∞—Ä–ø–ª–∞—Ç–µ?")) {
            await fetch(`/api/salaries/${id}/`, { method: "DELETE" });
            loadSalaries();
        }
    }

    function calculateSalary(employeeId) {
        fetch(`/generate-salary/${employeeId}/`)
            .then(response => response.json())
            .then(data => {
                alert(`–†–∞—Å—á–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω! –ò—Ç–æ–≥–æ–≤–∞—è –∑–∞—Ä–ø–ª–∞—Ç–∞: ${data.total_salary}`);
                loadSalaries();
            })
            .catch(error => console.error("–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞:", error));
    }

    function editSalary(id, employeeId, month, year, base_salary, overtime_hours, unpaid_leave_days, bonuses, deductions) {
        document.getElementById("salary_id").value = id;
        document.getElementById("salary_employee").value = employeeId;
        document.getElementById("salary_month").value = month;
        document.getElementById("salary_year").value = year;
        document.getElementById("salary_base").value = base_salary ?? 0;
        document.getElementById("overtime_hours").value = overtime_hours ?? 0;
        document.getElementById("unpaid_leave_days").value = unpaid_leave_days ?? 0;
        document.getElementById("salary_bonuses").value = bonuses ?? 0;
        document.getElementById("salary_deductions").value = deductions ?? 0;
    }

    document.getElementById("salary-form").addEventListener("submit", async function(e) {
    e.preventDefault();

    let id = document.getElementById("salary_id").value;
    let url = id ? `/api/salaries/${id}/` : "/api/salaries/";
    let method = id ? "PUT" : "POST";

    let salaryData = {
        employee_id: document.getElementById("salary_employee").value,
        month: document.getElementById("salary_month").value,
        year: parseInt(document.getElementById("salary_year").value) || 0,
        base_salary: parseFloat(document.getElementById("salary_base").value) || 0,
        overtime_hours: parseFloat(document.getElementById("overtime_hours").value) || 0,
        unpaid_leave_days: parseInt(document.getElementById("unpaid_leave_days").value) || 0,
        bonuses: parseFloat(document.getElementById("salary_bonuses").value) || 0,
        deductions: parseFloat(document.getElementById("salary_deductions").value) || 0
    };

    try {
        let response = await fetch(url, {
            method: method,
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCSRFToken()
            },
            body: JSON.stringify(salaryData)
        });

        if (response.ok) {
            alert("‚úÖ –ó–∞—Ä–ø–ª–∞—Ç–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!");
            loadSalaries();
            document.getElementById("salary-form").reset();
        } else if (response.status === 403) {
            alert("‚õî –û—à–∏–±–∫–∞ 403: –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –∏ CSRF —Ç–æ–∫–µ–Ω!");
        } else {
            let errorData = await response.json();
            console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:", errorData);
            alert("‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: " + JSON.stringify(errorData));
        }
    } catch (error) {
        console.error("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏:", error);
        alert("‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞—Ä–ø–ª–∞—Ç—É.");
    }
});


    document.addEventListener("DOMContentLoaded", () => {
        loadEmployees();
        loadEmployeesForFilter();
        loadSalaries();
    });

    function downloadReport(format) {
        let month = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –º–µ—Å—è—Ü–∞ (1-12) –∏–ª–∏ –æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –≤—Å–µ—Ö –º–µ—Å—è—Ü–µ–≤:");
        let year = prompt("–í–≤–µ–¥–∏—Ç–µ –≥–æ–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 2025) –∏–ª–∏ –æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º:");

        let url = `/report/salary/${format}/`;
        if (year) url += `${year}/`;
        if (month) url += `${month}/${year}/`;

        window.location.href = url;
    }

</script>

{% endblock %}
